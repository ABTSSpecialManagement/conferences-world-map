<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Conferences 2026 — Mapbox</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.css" rel="stylesheet" />
  <style>
    :root { --sidebar-w: 320px; --right-w: 380px; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, sans-serif; }
    #map { position: absolute; top:0; bottom:0; left: var(--sidebar-w); right: var(--right-w); }
    #menu {
      position: absolute; top:0; left:0; bottom:0;
      width: var(--sidebar-w); overflow:auto; background:#fff;
      padding:16px 14px; border-right:1px solid #e6e6e6;
    }
    #cards-panel {
      position: absolute; top:0; right:0; bottom:0;
      width: var(--right-w); overflow:auto; background:#fafafa;
      border-left:1px solid #e6e6e6; padding:16px 14px;
    }
    .section-title { font-size:14px; font-weight:700; margin:12px 0 6px; }
    .semester { border:1px solid #eee; border-radius:12px; padding:10px 12px; margin-bottom:12px; }
    .checkbox-row { display:flex; align-items:center; gap:8px; font-size:14px; padding:4px 2px; border-radius:8px; }
    .checkbox-row:hover { background:#f7f7f7; }
    .dot { width:10px; height:10px; border-radius:50%; display:inline-block; border:1px solid rgba(0,0,0,.15); }
    button.clear { display:block; margin-top:12px; padding:8px 12px; font-size:13px;
      border:1px solid #ccc; border-radius:8px; background:#f9f9f9; cursor:pointer; }

    .card-group { margin-bottom:16px; }
    .card-group-title { font-size:13px; font-weight:600; margin-bottom:6px; display:flex; align-items:center; gap:6px; }
    .card {
      background:white; border:1px solid #ddd; border-radius:10px;
      padding:10px 12px; margin-bottom:8px; box-shadow:0 1px 2px rgba(0,0,0,0.05);
      cursor:pointer; transition: background 0.2s, border-color 0.2s;
    }
    .card:hover { background:#f2f7ff; border-color:#aac8ff; }
    .card.selected { background:#e6f0ff; border-color:#4a90e2; box-shadow:0 0 0 2px rgba(74,144,226,0.4); }
    .card-title { font-size:14px; font-weight:600; }
    .card-sub { font-size:13px; color:#666; }
    .card-dates { font-size:12px; color:#444; margin-top:4px; }
    .card-link { display:inline-block; font-size:12px; margin-top:6px; text-decoration:underline; }

    /* map view toggle */
    #view-toggle {
      display:flex; align-items:center; gap:8px; margin-bottom:10px; padding:8px 10px;
      background:#fff; border:1px solid #e6e6e6; border-radius:10px;
    }
    #view-toggle label { font-size:13px; display:flex; align-items:center; gap:6px; }
    #view-toggle input { accent-color:#4a90e2; }
  </style>
</head>
<body>
  <div id="menu">
    <div class="section-title">Filters</div>
    <div id="filters"></div>
    <button class="clear" id="clearAll">Clear All</button>
  </div>

  <div id="map"></div>

  <div id="cards-panel">
    <div class="section-title">Map view</div>
    <div id="view-toggle" role="group" aria-label="Map view">
      <label><input type="radio" name="mapview" value="2d" checked> 2D (streets)</label>
      <label><input type="radio" name="mapview" value="3d"> 3D globe</label>
    </div>

    <div class="section-title">Selected Conferences</div>
    <div id="cards"></div>
  </div>

  <script>
    mapboxgl.accessToken = 'pk.eyJ1IjoibWFqYS1wYXZsaWNpYyIsImEiOiJjbWVpYnloeWowMG5xMmtzOGdnN2tjempnIn0.2LRD1_4AAyAVQWZ9kTZa2A';

    let activePopup = null;
    let activeCard = null;

    // --- City dictionary (fixes typos/variants) ---
    const cityCoords = {
      "San Francisco": [-122.4194, 37.7749],
      "Edinburgh": [-3.1883, 55.9533],
      "Dublin": [-6.2603, 53.3498],
      "Salt Lake City": [-111.8910, 40.7608],
      "San Diego": [-117.1611, 32.7157],
      "Hong Kong": [114.1694, 22.3193],
      "Stockholm": [18.0686, 59.3293],
      "Los Angeles": [-118.2437, 34.0522],
      "Copenhagen": [12.5683, 55.6761],
      "Lisabon": [-9.1393, 38.7223],
      "Lisbon": [-9.1393, 38.7223],
      "Miami": [-80.1918, 25.7617],
      "Phoenix": [-112.0740, 33.4484],
      "Orlando": [-81.3792, 28.5383],
      "Budapest": [19.0402, 47.4979],
      "London": [-0.1276, 51.5074],
      "Seville": [-5.9845, 37.3891],
      "Krakow": [19.9445, 50.0647],
      "San Antonio": [-98.4936, 29.4241],
      "New Orleans": [-90.0715, 29.9511],
      "Florence": [11.2558, 43.7696],
      "Denver": [-104.9903, 39.7392],
      "Prague": [14.4378, 50.0755],
      "Warsaw": [21.0122, 52.2297],
      "San Juan": [-66.1057, 18.4655],
      "São Paulo": [-46.6333, -23.5505],
      "Sao Paulo": [-46.6333, -23.5505],
      "Paris": [2.3522, 48.8566],
      "Munich": [11.5820, 48.1351],
      "Kuala Lumpur": [101.6869, 3.1390],
      "Washington, DC": [-77.0369, 38.9072],
      "Washington": [-77.0369, 38.9072],
      "Toronto": [-79.3832, 43.6532],
      "Berlin": [13.4050, 52.5200],
      "Istanbul, Turkey": [28.9784, 41.0082],
      "Istanbul": [28.9784, 41.0082],
      "Barcelona": [2.1734, 41.3851],
      "Charlotte": [-80.8431, 35.2271],
      "Chicago": [-87.6298, 41.8781],
      "Glasgow": [-4.2518, 55.8642],
      "Athens": [23.7275, 37.9838],
      "Philadelphia": [-75.1652, 39.9526],
      "Amsterdam": [4.9041, 52.3676],
      "Lugano": [8.9511, 46.0037],
      "Lille": [3.0573, 50.6292],
      "Geneva": [6.1432, 46.2044],
      "Queensland": [153.0251, -27.4698], // Brisbane
      "Marseilles": [5.3698, 43.2965],
      "Marseille": [5.3698, 43.2965],
      "Seoul": [126.9780, 37.5665],
      "Hiroshima": [132.4553, 34.3853],
      "Vienna": [16.3738, 48.2082],
      "Thessaloniki": [22.9444, 40.6401],
      "Madrid": [-3.7038, 40.4168],
      "Las Vegas": [-115.1398, 36.1699],
      "Atlanta": [-84.3880, 33.7490],
      "Boston": [-71.0589, 42.3601],
      "San Diego County": [-117.1611, 32.7157] // safety
    };

    const normalizeCity = (s) => {
      if (!s) return s;
      return s
        .replace(/\bChopenhagen\b/i, 'Copenhagen')
        .replace(/\bLisabon\b/i, 'Lisbon')
        .replace(/\bMarseilles\b/i, 'Marseille')
        .replace(/\bWashington\b(?!,\s*DC\b)/i, 'Washington, DC')
        .trim();
    };

    // color palette
    const palette = [
      "#e6194b","#3cb44b","#ffe119","#4363d8","#f58231","#911eb4","#46f0f0","#f032e6",
      "#bcf60c","#fabebe","#008080","#e6beff","#9a6324","#fffac8","#800000","#aaffc3",
      "#808000","#ffd8b1","#000075","#808080","#ffe4e1","#40e0d0","#6a3d9a","#b15928",
      "#2b908f","#ff7f0e","#1f77b4","#2ca02c","#d62728","#9467bd"
    ];

    // Build map
    const map = new mapboxgl.Map({
      container:'map',
      style:'mapbox://styles/mapbox/streets-v12',
      center:[10,35],
      zoom:2.2,
      projection:'mercator'
    });

    let features = [];
    let distinctSubs = [];
    let subColor = {};

    const filtersRoot = document.getElementById('filters');
    const cardsRoot   = document.getElementById('cards');

    // -------- Data loading from JSON --------
    fetch('conferences_2026.json')
      .then(r => r.json())
      .then(json => {
        features = jsonToFeatures(json);
        distinctSubs = [...new Set(features.map(f => f.properties.subcategory))].sort();
        subColor = {}; distinctSubs.forEach((s,i)=> subColor[s] = palette[i % palette.length]);

        map.once('load', initLayersAndUI);
      })
      .catch(err => {
        console.error('Failed to load JSON', err);
        alert('Could not load conferences_2026.json');
      });

    // Convert your JSON rows into GeoJSON features
    function jsonToFeatures(rows){
      const feats = [];
      for (const r of rows){
        const sem = (r.semester || '').trim();                 // "I" | "II"
        const semesterLabel = sem === 'I' ? 'I semester' : (sem === 'II' ? 'II semester' : sem);
        const sub = r.subspecialty || r.sub || 'Other';
        const name = r.short_name || r.name || '(TBA)';
        const full = r.full_name || '';
        const cityRaw = normalizeCity(r.location_raw || r.city || '');
        const start = normalizeDate(r.start_date || r.start);
        const end   = normalizeDate(r.end_date   || r.end);
        const link  = r.link || '';
        let coords = null;

        // Prefer explicit lat/lon if provided
        if (Number.isFinite(r.lon) && Number.isFinite(r.lat)) {
          coords = [r.lon, r.lat];
        } else if (cityRaw && cityCoords[cityRaw]) {
          coords = cityCoords[cityRaw];
        }

        if (!coords) continue; // skip rows we can't place

        feats.push({
          type:'Feature',
          properties:{
            semester: semesterLabel,
            subcategory: sub,
            name: name,
            full_name: full,
            location: cityRaw,
            start: start || 'TBA',
            end: end || 'TBA',
            link: link || ''
          },
          geometry:{ type:'Point', coordinates: coords }
        });
      }
      return feats;
    }

    function normalizeDate(s){
      if (!s) return null;
      // accept "YYYY-MM-DD" or "M/D/YYYY"
      const iso = /^\d{4}-\d{2}-\d{2}$/;
      const us  = /^\d{1,2}\/\d{1,2}\/\d{4}$/;
      try{
        if (iso.test(s)) return s;
        if (us.test(s)) {
          const [m,d,y] = s.split('/').map(Number);
          const mm = String(m).padStart(2,'0'), dd = String(d).padStart(2,'0');
          return `${y}-${mm}-${dd}`;
        }
      }catch(e){}
      return s; // leave as-is if already friendly
    }

    function initLayersAndUI(){
      map.setPitch(0); map.setBearing(0);

      const data = { type:'FeatureCollection', features };
      map.addSource('conferences',{type:'geojson', data});

      const matchColor = ['match',['get','subcategory']];
      distinctSubs.forEach(s => { matchColor.push(s, subColor[s]); });
      matchColor.push('#ccc');

      map.addLayer({
        id:'conferences-layer', type:'circle', source:'conferences',
        paint:{ 'circle-radius':8, 'circle-color':matchColor, 'circle-stroke-width':1, 'circle-stroke-color':'#fff' }
      });

      buildSidebar();
      applyFilters(); // start with nothing shown until user checks boxes

      // pin -> popup + select matching card
      map.on('click','conferences-layer',(e)=>{
        const f = e.features[0], p = f.properties;
        openPopupAndSelectCard(f, p);
      });

      // map view toggle
      document.getElementById('view-toggle').addEventListener('change', (e) => {
        const val = (e.target.closest('input') || {}).value;
        if (!val) return;
        if (val === '2d') {
          map.setProjection('mercator');
          map.setStyle('mapbox://styles/mapbox/streets-v12');
          map.once('styledata', ()=> map.setPaintProperty('conferences-layer','circle-color', matchColor));
        } else if (val === '3d') {
          map.setProjection('globe');
          map.setStyle('mapbox://styles/mapbox/light-v11');
          map.once('styledata', ()=>{
            map.setPaintProperty('conferences-layer','circle-color', matchColor);
            if (map.getFog()) map.setFog({}); else map.setFog({});
          });
        }
      });
    }

    function openPopupAndSelectCard(feature, props){
      // close existing
      if (activePopup) activePopup.remove();
      if (activeCard) activeCard.classList.remove('selected');

      // select card
      const card = [...document.querySelectorAll('.card')]
        .find(c => c.dataset.name === props.name);
      if (card) {
        card.classList.add('selected');
        activeCard = card;
        card.scrollIntoView({ behavior:'smooth', block:'center' });
      }

      // animate on globe: turn the world to the point
      const viewMode = document.querySelector('input[name="mapview"]:checked').value;
      if (viewMode === '3d') {
        map.easeTo({
          center: feature.geometry.coordinates,
          zoom: Math.max(map.getZoom(), 3.2),
          duration: 1500,
          pitch: 45
        });
      }

      // popup HTML (with link if present)
      const linkHTML = props.link ? `<div style="margin-top:6px"><a href="${props.link}" target="_blank" rel="noopener" style="color:#1f6feb;text-decoration:underline">Open website ↗</a></div>` : '';
      const popup = new mapboxgl.Popup()
        .setLngLat(feature.geometry.coordinates)
        .setHTML(`
          <div style="font-weight:700">${props.name}</div>
          <div>${props.full_name || ''}</div>
          <div><b>${props.location || ''}</b></div>
          <div>${props.start} → ${props.end}</div>
          ${linkHTML}
        `)
        .addTo(map);

      activePopup = popup;
      popup.on('close', ()=>{
        if (activeCard) activeCard.classList.remove('selected');
        activeCard = null; activePopup = null;
      });
    }

    // -------- Sidebar (filters) --------
    function groupBySemesterAndSub(dataFeatures){
      const bySem = {};
      for (const f of dataFeatures){
        const sem = f.properties.semester, sub = f.properties.subcategory;
        if (!bySem[sem]) bySem[sem] = new Set();
        bySem[sem].add(sub);
      }
      const res = {};
      for (const sem of Object.keys(bySem)) res[sem] = [...bySem[sem]].sort();
      return res;
    }
    function colorDot(c){ return `<span class="dot" style="background:${c}"></span>`; }

    function buildSidebar(){
      const grouped = groupBySemesterAndSub(features);
      const wrapper = document.createElement('div');

      Object.keys(grouped).sort().forEach(sem=>{
        const box=document.createElement('div'); box.className='semester';
        const titleRow=document.createElement('label'); titleRow.className='checkbox-row section-title';
        titleRow.innerHTML=`<input type="checkbox" data-semester-master="${sem}"> ${sem}`;
        box.appendChild(titleRow);

        grouped[sem].forEach(sub=>{
          const row=document.createElement('label'); row.className='checkbox-row';
          row.innerHTML=`<input type="checkbox" data-semester="${sem}" data-sub="${sub}"> ${colorDot(subColor[sub])} ${sub}`;
          box.appendChild(row);
        });
        wrapper.appendChild(box);
      });

      filtersRoot.innerHTML=''; filtersRoot.appendChild(wrapper);

      filtersRoot.addEventListener('change', e=>{
        const t = e.target;
        if (t.dataset.semesterMaster){
          const sem=t.dataset.semesterMaster;
          filtersRoot.querySelectorAll(`input[data-semester="${sem}"]`).forEach(cb=> cb.checked = t.checked);
          t.indeterminate=false;
        }
        if (t.dataset.sub){
          const sem=t.dataset.semester;
          const subs=[...filtersRoot.querySelectorAll(`input[data-semester="${sem}"]`)];
          const master=filtersRoot.querySelector(`input[data-semester-master="${sem}"]`);
          const all=subs.every(cb=>cb.checked), none=subs.every(cb=>!cb.checked);
          master.checked=all; master.indeterminate=!all && !none;
        }
        applyFilters();
      });

      document.getElementById('clearAll').addEventListener('click', ()=>{
        filtersRoot.querySelectorAll('input[type=checkbox]').forEach(cb=>{cb.checked=false; cb.indeterminate=false;});
        applyFilters();
      });
    }

    // -------- Filtering + cards (with links) --------
    function applyFilters(){
      const subChecked=[...filtersRoot.querySelectorAll('input[data-sub]:checked')].map(i=>i.dataset.sub);

      if (subChecked.length===0){
        if (map.getLayer('conferences-layer')){
          map.setFilter('conferences-layer',['==',['get','subcategory'],'__none__']);
        }
        cardsRoot.innerHTML=''; return;
      }

      const filter=['in',['get','subcategory'],['literal',subChecked]];
      map.setFilter('conferences-layer', filter);

      // group features by subcategory
      const bySub = {};
      features.forEach(f=>{
        if (subChecked.includes(f.properties.subcategory)){
          (bySub[f.properties.subcategory] ||= []).push(f);
        }
      });

      // sort inside each sub by start date (if parseable)
      const parse = (s)=> Date.parse(s) || Infinity;
      Object.values(bySub).forEach(arr => arr.sort((a,b)=> parse(a.properties.start)-parse(b.properties.start)));

      // build cards
      cardsRoot.innerHTML='';
      Object.keys(bySub).sort().forEach(sub=>{
        const groupDiv=document.createElement('div'); groupDiv.className='card-group';
        groupDiv.innerHTML=`<div class="card-group-title">${colorDot(subColor[sub])} ${sub}</div>`;

        bySub[sub].forEach(f=>{
          const p=f.properties;
          const card=document.createElement('div'); card.className='card';
          card.dataset.name = p.name;
          card.innerHTML=`
            <div class="card-title">${p.name}</div>
            <div class="card-sub">${p.location}</div>
            <div class="card-dates">${p.start} → ${p.end}</div>
            ${p.link ? `<a class="card-link" href="${p.link}" target="_blank" rel="noopener">Open website ↗</a>` : ``}
          `;
          card.addEventListener('click', ()=> openPopupAndSelectCard(f, p));
          groupDiv.appendChild(card);
        });
        cardsRoot.appendChild(groupDiv);
      });
    }
  </script>
</body>
</html>
