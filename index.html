<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Conferences 2026 — Mapbox</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.css" rel="stylesheet" />
  <style>
    :root { --sidebar-w: 320px; --right-w: 360px; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, sans-serif; }
    #map { position: absolute; top:0; bottom:0; left: var(--sidebar-w); right: var(--right-w); }
    #menu {
      position: absolute; top:0; left:0; bottom:0;
      width: var(--sidebar-w); overflow:auto; background:#fff;
      padding:16px 14px; border-right:1px solid #e6e6e6;
    }
    #cards-panel {             /* NEW right panel */
      position: absolute; top:0; right:0; bottom:0;
      width: var(--right-w); overflow:auto; background:#fafafa;
      border-left:1px solid #e6e6e6; padding:16px 14px;
    }
    .section-title { font-size:14px; font-weight:700; margin:12px 0 6px; }
    .semester { border:1px solid #eee; border-radius:12px; padding:10px 12px; margin-bottom:12px; }
    .checkbox-row { display:flex; align-items:center; gap:8px; font-size:14px; padding:4px 2px; border-radius:8px; }
    .checkbox-row:hover { background:#f7f7f7; }
    .dot { width:10px; height:10px; border-radius:50%; display:inline-block; border:1px solid rgba(0,0,0,.15); }
    button.clear { display:block; margin-top:12px; padding:8px 12px; font-size:13px;
      border:1px solid #ccc; border-radius:8px; background:#f9f9f9; cursor:pointer; }
    .card-group { margin-bottom:16px; }
    .card-group-title { font-size:13px; font-weight:600; margin-bottom:6px; display:flex; align-items:center; gap:6px; }
    .card { background:white; border:1px solid #ddd; border-radius:10px; padding:10px 12px; margin-bottom:8px;
      box-shadow:0 1px 2px rgba(0,0,0,0.05); cursor:pointer; }
    .card-title { font-size:14px; font-weight:600; }
    .card-sub { font-size:13px; color:#666; }
    .card-dates { font-size:12px; color:#444; margin-top:4px; }
    .card {
  background:white;
  border:1px solid #ddd;
  border-radius:10px;
  padding:10px 12px;
  margin-bottom:8px;
  box-shadow:0 1px 2px rgba(0,0,0,0.05);
  cursor:pointer;
  transition: background 0.2s, border-color 0.2s;
}
.card:hover {
  background:#f2f7ff;          /* soft blue tint */
  border-color:#aac8ff;
}
.card.selected {               /* clicked/active */
  background:#e6f0ff;
  border-color:#4a90e2;
  box-shadow:0 0 0 2px rgba(74,144,226,0.4);
}
  </style>
</head>
<body>
  <div id="menu">
    <div class="section-title">Filters</div>
    <div id="filters"></div>
    <button class="clear" id="clearAll">Clear All</button>
  </div>

  <div id="map"></div>

  <!-- NEW Right panel -->
  <div id="cards-panel">
    <div class="section-title">Selected Conferences</div>
    <div id="cards"></div>
  </div>

  <script>
    // Mapbox token
    mapboxgl.accessToken = 'pk.eyJ1IjoibWFqYS1wYXZsaWNpYyIsImEiOiJjbWVpYnloeWowMG5xMmtzOGdnN2tjempnIn0.2LRD1_4AAyAVQWZ9kTZa2A';
let activePopup = null;
let activeCard = null;

    // -----------------------------
    // City → [lng, lat] dictionary
    // (handles minor typos & variants)
    // -----------------------------
    const cityCoords = {
      "San Francisco": [-122.4194, 37.7749],
      "Edinburgh": [-3.1883, 55.9533],
      "Dublin": [-6.2603, 53.3498],
      "Salt Lake City": [-111.8910, 40.7608],
      "San Diego": [-117.1611, 32.7157],
      "Hong Kong": [114.1694, 22.3193],
      "Stockholm": [18.0686, 59.3293],
      "Los Angeles": [-118.2437, 34.0522],
      "Copenhagen": [12.5683, 55.6761],
      "Lisabon": [-9.1393, 38.7223], // treat as Lisbon
      "Lisbon": [-9.1393, 38.7223],
      "Miami": [-80.1918, 25.7617],
      "Phoenix": [-112.0740, 33.4484],
      "Orlando": [-81.3792, 28.5383],
      "Budapest": [19.0402, 47.4979],
      "London": [-0.1276, 51.5074],
      "Seville": [-5.9845, 37.3891],
      "Krakow": [19.9445, 50.0647],
      "San Antonio": [-98.4936, 29.4241],
      "New Orleans": [-90.0715, 29.9511],
      "Florence": [11.2558, 43.7696],
      "Denver": [-104.9903, 39.7392],
      "Prague": [14.4378, 50.0755],
      "Warsaw": [21.0122, 52.2297],
      "San Juan": [-66.1057, 18.4655],
      "São Paulo": [-46.6333, -23.5505],
      "Sao Paulo": [-46.6333, -23.5505],
      "Paris": [2.3522, 48.8566],
      "Munich": [11.5820, 48.1351],
      "Kuala Lumpur": [101.6869, 3.1390],
      "Washington, DC": [-77.0369, 38.9072],
      "Washington": [-77.0369, 38.9072],
      "Toronto": [-79.3832, 43.6532],
      "Berlin": [13.4050, 52.5200],
      "Istanbul, Turkey": [28.9784, 41.0082],
      "Istanbul": [28.9784, 41.0082],
      "Barcelona": [2.1734, 41.3851],
      "Charlotte": [-80.8431, 35.2271],
      "Chicago": [-87.6298, 41.8781],
      "Glasgow": [-4.2518, 55.8642],
      "Athens": [23.7275, 37.9838],
      "Philadelphia": [-75.1652, 39.9526],
      "Amsterdam": [4.9041, 52.3676],
      "Lugano": [8.9511, 46.0037],
      "Lille": [3.0573, 50.6292],
      "Geneva": [6.1432, 46.2044],
      "Queensland": [153.0251, -27.4698], // Brisbane (QLD capital)
      "Marseilles": [5.3698, 43.2965], // treat as Marseille
      "Marseille": [5.3698, 43.2965],
      "Seoul": [126.9780, 37.5665],
      "Hiroshima": [132.4553, 34.3853],
      "Vienna": [16.3738, 48.2082],
      "Thessaloniki": [22.9444, 40.6401],
      "Madrid": [-3.7038, 40.4168],
      "Las Vegas": [-115.1398, 36.1699]
    };

    // Normalize city strings
    const normalizeCity = (s) => {
      if (!s) return s;
      return s
        .replace(/\bChopenhagen\b/i, 'Copenhagen')
        .replace(/\bLisabon\b/i, 'Lisbon')
        .replace(/\bMarseilles\b/i, 'Marseille')
        .replace(/\bWashington\b(?!,\s*DC\b)/i, 'Washington, DC')
        .trim();
    };

    // -----------------------------
    // Raw records from Sheet 1
    // (I + II semester)
    // -----------------------------
    const records = [
      // I semester
      {semester:'I semester', sub:'Oncology', name:'ASCO GI', full:'ASCO Gastrointestinal (GI) Cancers Symposium', city:'San Francisco', start:'1/8/2026', end:'1/10/2026'},
      {semester:'I semester', sub:'Hepatology', name:'EASL-LCS', full:'EASL Liver Cancer Summit', city:'Edinburgh', start:'1/22/2026', end:'1/24/2026'},
      {semester:'I semester', sub:'Hematology', name:'EAHAD', full:'European Association for Haemophilia and Allied Disorders', city:'Dublin', start:'2/3/2026', end:'2/6/2026'},
      {semester:'I semester', sub:'Hematology', name:'ASTCT/CIBMTR', full:'American Society for Transplantation and Cellular Therapy /Center for International Blood and Marrow Transplant Research', city:'Salt Lake City', start:'2/4/2026', end:'2/7/2026'},
      {semester:'I semester', sub:'Neurology', name:'ACTRIMS Forum', full:'Americas Committee for Treatment and Research in Multiple Sclerosis', city:'San Diego', start:'2/5/2026', end:'2/7/2026'},
      {semester:'I semester', sub:'Ophthalmology', name:'APAO', full:'Asia-Pacific Academy of Ophthalmology', city:'Hong Kong', start:'2/5/2026', end:'2/8/2026'},
      {semester:'I semester', sub:'Gastroenterology', name:'ECCO', full:'European Crohn’s and Colitis Organisation', city:'Stockholm', start:'2/18/2026', end:'2/21/2026'},
      {semester:'I semester', sub:'Healthcare Innovation', name:'VIVE', full:'ViVE – The Healthcare Innovation Conference', city:'Los Angeles', start:'2/22/2026', end:'2/25/2026'},
      {semester:'I semester', sub:'Oncology', name:'ASCO GU', full:'ASCO Genitourinary (GU) Cancers Symposium', city:'San Francisco', start:'2/26/2026', end:'2/28/2026'},
      {semester:'I semester', sub:'Oncology', name:'ESGO', full:'European Society of Gynaecological Oncology', city:'Copenhagen', start:'2/26/2026', end:'2/28/2026'},
      {semester:'I semester', sub:'Rheumatology', name:'SLEuro', full:'15th European Lupus Meeting', city:'Lisabon', start:'3/4/2026', end:'3/7/2026'},
      {semester:'I semester', sub:'Oncology', name:'MBCC', full:'Miami Breast Cancer Conference', city:'Miami', start:'3/5/2026', end:'3/8/2026'},
      {semester:'I semester', sub:'Oncology', name:'SSO', full:'Society of Surgical Oncology', city:'Phoenix', start:'3/5/2026', end:'3/7/2026'},
      {semester:'I semester', sub:'Neurology', name:'MDA', full:'Muscular Dystrophy Association', city:'Orlando', start:'3/8/2026', end:'3/11/2026'},
      {semester:'I semester', sub:'Neurology', name:'SMA Europe', full:'International Scientific Congress on Spinal Muscular Atrophy', city:'Budapest', start:'3/12/2026', end:'3/14/2026'},
      {semester:'I semester', sub:'Urology', name:'EAU', full:'European Association of Urology', city:'London', start:'3/13/2026', end:'3/16/2026'},
      {semester:'I semester', sub:'Neurology', name:'AD/PD', full:'Alzheimer\'s Disease & Parkinson\'s Disease International Conference.', city:'Chopenhagen', start:'3/17/2026', end:'3/21/2026'},
      {semester:'I semester', sub:'Oncology', name:'ICHNO', full:'International Congress on Innovative Approaches in Head and Neck Oncology', city:'Seville', start:'3/19/2026', end:'3/21/2026'},
      {semester:'I semester', sub:'Ophthalmology', name:'COPHy', full:'Congress on Controversies in Ophthalmology', city:'Krakow', start:'3/20/2026', end:'3/21/2026'},
      {semester:'I semester', sub:'Pathology', name:'USCAP', full:'United States and Canadian Academy of Pathology', city:'San Antonio', start:'3/21/2026', end:'3/26/2026'},
      {semester:'I semester', sub:'Hematology', name:'HOPA', full:'Hematology/Oncology Pharmacy Association', city:'New Orleans', start:'3/25/2026', end:'3/28/2026'},
      {semester:'I semester', sub:'Psychiatry', name:'SIRS', full:'Schizophrenia International Research Society', city:'Florence', start:'3/25/2026', end:'3/29/2026'},
      {semester:'I semester', sub:'Oncology', name:'ELCC', full:'European Lung Cancer Congress', city:'Copenhagen', start:'3/25/2026', end:'3/28/2026'},
      {semester:'I semester', sub:'Dermatology', name:'AAD', full:'American Academy of Dermatology', city:'Denver', start:'3/27/2026', end:'3/31/2026'},
      {semester:'I semester', sub:'Psychiatry', name:'EPA', full:'European Psychiatric Association', city:'Prague', start:'3/28/2026', end:'3/31/2026'},
      {semester:'I semester', sub:'Perinatal Medicine', name:'ECPM', full:'European Congress of Perinatal Medicine', city:'Warsaw', start:'4/9/2026', end:'4/11/2026'},
      {semester:'I semester', sub:'Oncology', name:'SGO', full:'Society of Gynecologic Oncology', city:'San Juan', start:'4/11/2026', end:'4/13/2026'},
      {semester:'I semester', sub:'Cardiology', name:'SOCESP', full:'Society of Cardiology of the State of São Paulo', city:'São Paulo', start:'4/14/2026', end:'4/16/2026'},
      {semester:'I semester', sub:'Hematology', name:'HFA', full:'Hemophilia Federation of America', city:'New Orleans', start:'4/16/2026', end:'4/19/2026'},
      {semester:'I semester', sub:'Oncology', name:'EIKCS', full:'European International Kidney Cancer Symposium', city:'Paris', start:'4/16/2026', end:'4/18/2026'},
      {semester:'I semester', sub:'Infectious Diseases', name:'ESCMID', full:'The European Society of Clinical Microbiology and Infectious Diseases', city:'Munich', start:'4/17/2026', end:'4/21/2026'},
      {semester:'I semester', sub:'Oncology', name:'AACR', full:'American Association for Cancer Research', city:'San Diego', start:'4/17/2026', end:'4/22/2026'},
      {semester:'I semester', sub:'Hematology', name:'WFH', full:'The World Federation of Hemophilia', city:'Kuala Lumpur', start:'4/19/2026', end:'4/22/2026'},
      {semester:'I semester', sub:'Dermatology', name:'EADO', full:'European Association of Dermato-Oncology', city:'Prague', start:'4/23/2026', end:'4/25/2026'},
      {semester:'I semester', sub:'Oncology', name:'ONS', full:'Oncology Nursing Society', city:'Washington, DC', start:'4/24/2026', end:'4/28/2026'},
      {semester:'I semester', sub:'Cardiothoracic Transplantation', name:'ISHLT', full:'International Society for Heart and Lung Transplantation', city:'Toronto', start:'4/25/2026', end:'4/23/2026'},
      {semester:'I semester', sub:'Obstetrics & Gynecology', name:'ACOG', full:'American College of Obstetricians and Gynecologists', city:'Washington', start:'5/1/2026', end:'5/3/2026'},
      {semester:'I semester', sub:'Oncology', name:'ESMO BC', full:'ESMO Breast Cancer Congress', city:'Berlin', start:'5/6/2026', end:'5/8/2026'},
      {semester:'I semester', sub:'Obesity / Metabolic Disorders', name:'ECO', full:'European Association for the Study of Obesity', city:'Istanbul, Turkey', start:'5/12/2026', end:'5/15/2026'},
      {semester:'I semester', sub:'Pulmonology', name:'ATS', full:'American Thoracic Society', city:'Orlando', start:'5/15/2026', end:'5/20/2026'},
      {semester:'I semester', sub:'Urology', name:'AUA', full:'American Urological Association', city:'Washington', start:'5/15/2026', end:'5/18/2026'},
      {semester:'I semester', sub:'Hepatology', name:'EASL', full:'European Association for the Study of the Liver', city:'Barcelona', start:'5/27/2026', end:'5/30/2026'},
      {semester:'I semester', sub:'Neurology', name:'CMSC', full:'Consortium of Multiple Sclerosis Centers', city:'Charlotte', start:'5/27/2026', end:'5/30/2026'},
      {semester:'I semester', sub:'Oncology', name:'ASCO', full:'American Society of Clinical Oncology', city:'Chicago', start:'5/29/2026', end:'6/2/2026'},
      {semester:'I semester', sub:'Rheumatology', name:'EULAR', full:'European Congress of Rheumatology', city:'London', start:'5/30/2026', end:'6/1/2026'},
      {semester:'I semester', sub:'Nephrology', name:'ERA', full:'European Renal Association', city:'Glasgow', start:'6/3/2026', end:'6/6/2026'},
      {semester:'I semester', sub:'Thoracic Surgery', name:'ESTS', full:'European Conference on General Thoracic Surgery', city:'Athens', start:'6/7/2026', end:'6/9/2026'},
      {semester:'I semester', sub:'Hematology', name:'EHA', full:'European Hematology Association', city:'Stockholm', start:'6/11/2026', end:'6/14/2026'},
      {semester:'I semester', sub:'Oncology', name:'ESMO Asia', full:'ESMO Targeted Anticancer Therapies (TAT) Asia Congress', city:'Hong Kong', start:'6/12/2026', end:'6/14/2026'},
      {semester:'I semester', sub:'Oncology', name:'GAWC', full:'Global Academy of Women’s Cancer', city:'Munich', start:'6/13/2026', end:'6/14/2026'},
      {semester:'I semester', sub:'Drug Development / Regulatory Science', name:'DIA', full:'Drug Information Association', city:'Philadelphia', start:'6/14/2026', end:'6/18/2026'},
      {semester:'I semester', sub:'Healthcare Innovation', name:'HLTH Europe', full:'HLTH Europe: The Premier Healthcare Innovation Event in Europe', city:'Amsterdam', start:'6/15/2026', end:'6/18/2026'},
      {semester:'I semester', sub:'Oncology', name:'ICML', full:'International Conference on Malignant Lymphoma', city:'Lugano', start:'6/17/2026', end:'6/21/2026'},
      {semester:'I semester', sub:'Pediatric', name:'ESPGHAN', full:'European Society for Paediatric Gastroenterology, Hepatology and Nutrition', city:'Lille', start:'6/24/2026', end:'6/27/2026'},
      {semester:'I semester', sub:'Neurology', name:'CureSMA', full:'Annual SMA Research & Clinical Care Meeting', city:'Orlando', start:'6/26/2026', end:'6/29/2026'},
      {semester:'I semester', sub:'Neurology', name:'EAN', full:'European Academy of Neurology', city:'Geneva', start:'6/27/2026', end:'6/30/2026'},

      // II semester
      {semester:'II semester', sub:'Oncology', name:'ESMO GI', full:'ESMO Gastrointestinal Cancers Congress', city:'Munich', start:'7/1/2026', end:'7/4/2026'},
      {semester:'II semester', sub:'Hematology', name:'ISTH', full:'International Society on Thrombosis and Haemostasis', city:'Paris', start:'7/11/2026', end:'7/15/2026'},
      {semester:'II semester', sub:'Cardiology', name:'ESC', full:'European Society of Cardiology', city:'Munich', start:'8/28/2026', end:'8/31/2026'},
      {semester:'II semester', sub:'Ophthalmology', name:'APVRS', full:'Asia-Pacific Vitreo-retina Society', city:'Queensland', start:'8/28/2026', end:'8/30/2026'},
      {semester:'II semester', sub:'Infectious Diseases', name:'ESWI', full:'World One Health Congress', city:'Lisabon', start:'9/4/2026', end:'9/7/2026'},
      {semester:'II semester', sub:'Pulmonology', name:'ERS', full:'European Respiratory Society', city:'Barcelona', start:'9/5/2026', end:'9/9/2026'},
      {semester:'II semester', sub:'Pediatric', name:'ESPE', full:'European Society for Paediatric Endocrinology', city:'Marseilles', start:'9/8/2026', end:'9/10/2026'},
      {semester:'II semester', sub:'Oncology', name:'WCLC/IASL', full:'World Conference on Lung Cancer', city:'Seoul', start:'9/12/2026', end:'9/15/2026'},
      {semester:'II semester', sub:'Neurology', name:'WMS', full:'World Muscle Society', city:'Hiroshima', start:'9/29/2026', end:'10/3/2026'},
      {semester:'II semester', sub:'Ophthalmology', name:'EURETINA', full:'European Society of Retina Specialists', city:'Vienna', start:'10/1/2026', end:'10/4/2026'},
      {semester:'II semester', sub:'Neurology', name:'MDS', full:'International Parkinson and Movement Disorder Society', city:'Seoul', start:'10/4/2026', end:'10/8/2026'},
      {semester:'II semester', sub:'Hematology', name:'DGHO', full:'German, Austrian and Swiss Societies of Hematology and Medical Oncology', city:'Vienna', start:'10/9/2026', end:'10/12/2026'},
      {semester:'II semester', sub:'Pediatric', name:'EPNS', full:'European Paediatric Neurology Society', city:'Thessaloniki', start:'10/16/2026', end:'10/17/2026'},
      {semester:'II semester', sub:'Gastroenterology', name:'UEGW', full:'United European Gastroenterology', city:'TBA', start:'10/17/2026', end:'10/20/2026'},
      {semester:'II semester', sub:'Oncology', name:'ESMO', full:'European Society for Medical Oncology', city:'Madrid', start:'10/23/2026', end:'10/27/2026'},
      {semester:'II semester', sub:'Allergy / Immunology', name:'ACAAI', full:'American College of Allergy, Asthma and Immunology', city:'Phoenix', start:'11/12/2026', end:'11/16/2026'},
      {semester:'II semester', sub:'Healthcare Innovation', name:'HLTH USA', full:'HLTH USA: The Premier Healthcare Innovation Event (USA)', city:'Las Vegas', start:'11/15/2026', end:'11/18/2026'}
    ];

    // Normalize & attach coordinates; skip items with unknown coords (e.g., TBA)
    const features = [];
    for (const r of records) {
      const city = normalizeCity(r.city);
      const coords = cityCoords[city];
      if (!coords) continue;
      features.push({
        type:'Feature',
        properties:{ semester:r.semester, subcategory:r.sub, name:r.name, full_name:r.full,
          location:city, start:r.start, end:r.end },
        geometry:{ type:'Point', coordinates:coords }
      });
    }
    const data = { type:'FeatureCollection', features };

    const distinctSubs = [...new Set(features.map(f=>f.properties.subcategory))].sort();
    const palette = ["#e6194b","#3cb44b","#ffe119","#0082c8","#f58231","#911eb4","#46f0f0","#f032e6",
      "#d2f53c","#fabebe","#008080","#e6beff","#aa6e28","#fffac8","#800000","#aaffc3","#808000",
      "#ffd8b1","#000080","#808080","#6a3d9a","#b15928","#2b908f","#ff1493"];
    const subColor = {}; distinctSubs.forEach((s,i)=>subColor[s]=palette[i%palette.length]);

    const map = new mapboxgl.Map({
      container:'map', style:'mapbox://styles/mapbox/streets-v12',
      center:[10,35], zoom:2.2, projection:'mercator'
    });

    map.on('load',()=>{
      map.setPitch(0); map.setBearing(0);
      map.addSource('conferences',{type:'geojson',data});

      const matchColor=['match',['get','subcategory']];
      distinctSubs.forEach(s=>{matchColor.push(s,subColor[s]);});
      matchColor.push('#ccc');

      map.addLayer({
        id:'conferences-layer', type:'circle', source:'conferences',
        paint:{ 'circle-radius':8, 'circle-color':matchColor, 'circle-stroke-width':1, 'circle-stroke-color':'#fff' }
      });

      buildSidebar();
      applyFilters(); // initial state → no pins/cards
    });

    map.on('click', 'conferences-layer', (e) => {
  const f = e.features[0];
  const p = f.properties;

  // Close existing popup + clear selection
  if (activePopup) activePopup.remove();
  if (activeCard) activeCard.classList.remove('selected');

  // Find matching card by name
  const card = [...document.querySelectorAll('.card')]
    .find(c => c.querySelector('.card-title').textContent === p.name);

  if (card) {
    card.classList.add('selected');
    activeCard = card;

    // 🔹 Smooth scroll sidebar to bring the card into view
    card.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }

  // Create popup
  const popup = new mapboxgl.Popup()
    .setLngLat(f.geometry.coordinates)
    .setHTML(`<div style="font-weight:700">${p.name}</div>
              <div>${p.full_name}</div>
              <div><b>${p.location}</b></div>
              <div>${p.start} → ${p.end}</div>`)
    .addTo(map);

  activePopup = popup;

  // When popup is closed → clear selection
  popup.on('close', () => {
    if (activeCard) activeCard.classList.remove('selected');
    activeCard = null;
    activePopup = null;
  });
});

    const filtersRoot=document.getElementById('filters');
    const cardsRoot=document.getElementById('cards');

    function groupBySemesterAndSub(dataFeatures){
      const bySem={};
      for(const f of dataFeatures){
        const sem=f.properties.semester, sub=f.properties.subcategory;
        if(!bySem[sem]) bySem[sem]=new Set();
        bySem[sem].add(sub);
      }
      const res={}; for(const sem of Object.keys(bySem)) res[sem]=[...bySem[sem]].sort();
      return res;
    }
    function colorDot(c){return `<span class="dot" style="background:${c}"></span>`;}

    function buildSidebar(){
      const grouped=groupBySemesterAndSub(features);
      const wrapper=document.createElement('div');
      Object.keys(grouped).sort().forEach(sem=>{
        const box=document.createElement('div'); box.className='semester';
        const titleRow=document.createElement('label'); titleRow.className='checkbox-row section-title';
        const semId=`sem-${sem.replace(/\s+/g,'-')}`;
        titleRow.innerHTML=`<input type="checkbox" data-semester-master="${sem}"> ${sem}`;
        box.appendChild(titleRow);
        grouped[sem].forEach(sub=>{
          const id=`sub-${sem}-${sub}`;
          const row=document.createElement('label'); row.className='checkbox-row';
          row.innerHTML=`<input type="checkbox" data-semester="${sem}" data-sub="${sub}"> ${colorDot(subColor[sub])} ${sub}`;
          box.appendChild(row);
        });
        wrapper.appendChild(box);
      });
      filtersRoot.innerHTML=''; filtersRoot.appendChild(wrapper);

      filtersRoot.addEventListener('change',e=>{
        const t=e.target;
        if(t.dataset.semesterMaster){
          const sem=t.dataset.semesterMaster;
          const subs=filtersRoot.querySelectorAll(`input[data-semester="${sem}"]`);
          subs.forEach(cb=>cb.checked=t.checked);
          t.indeterminate=false;
        }
        if(t.dataset.sub){
          const sem=t.dataset.semester;
          const subs=[...filtersRoot.querySelectorAll(`input[data-semester="${sem}"]`)];
          const master=filtersRoot.querySelector(`input[data-semester-master="${sem}"]`);
          const all=subs.every(cb=>cb.checked), none=subs.every(cb=>!cb.checked);
          master.checked=all; master.indeterminate=!all && !none;
        }
        applyFilters();
      });

      document.getElementById('clearAll').addEventListener('click',()=>{
        filtersRoot.querySelectorAll('input[type=checkbox]').forEach(cb=>{cb.checked=false; cb.indeterminate=false;});
        applyFilters();
      });
    }

    function applyFilters(){
      const subChecked=[...filtersRoot.querySelectorAll('input[data-sub]:checked')].map(i=>i.dataset.sub);
      if(subChecked.length===0){
        if(map.getLayer('conferences-layer')){
          map.setFilter('conferences-layer',['==',['get','subcategory'],'__none__']);
        }
        cardsRoot.innerHTML=''; return;
      }
      const filter=['in',['get','subcategory'],['literal',subChecked]];
      map.setFilter('conferences-layer',filter);

      // Build right-side cards
      const bySub={};
      features.forEach(f=>{
        if(subChecked.includes(f.properties.subcategory)){
          if(!bySub[f.properties.subcategory]) bySub[f.properties.subcategory]=[];
          bySub[f.properties.subcategory].push(f);
        }
      });
      cardsRoot.innerHTML='';
      Object.keys(bySub).sort().forEach(sub=>{
        const groupDiv=document.createElement('div'); groupDiv.className='card-group';
        groupDiv.innerHTML=`<div class="card-group-title">${colorDot(subColor[sub])} ${sub}</div>`;
        bySub[sub].forEach(f=>{
          const p=f.properties;
          const card=document.createElement('div'); card.className='card';
          card.innerHTML=`<div class="card-title">${p.name}</div>
                          <div class="card-sub">${p.location}</div>
                          <div class="card-dates">${p.start} → ${p.end}</div>`;
          card.addEventListener('click', () => {
  // Close existing popup + clear selection
  if (activePopup) activePopup.remove();
  if (activeCard) activeCard.classList.remove('selected');

  // Mark this card as selected
  card.classList.add('selected');
  activeCard = card;

  // Create popup
  const popup = new mapboxgl.Popup()
    .setLngLat(f.geometry.coordinates)
    .setHTML(`<div style="font-weight:700">${p.name}</div>
              <div>${p.full_name}</div>
              <div><b>${p.location}</b></div>
              <div>${p.start} → ${p.end}</div>`)
    .addTo(map);

  activePopup = popup;

  // When popup is closed → clear selection
  popup.on('close', () => {
    if (activeCard) activeCard.classList.remove('selected');
    activeCard = null;
    activePopup = null;
  });
});
          groupDiv.appendChild(card);
        });
        cardsRoot.appendChild(groupDiv);
      });
    }
  </script>
</body>
</html>