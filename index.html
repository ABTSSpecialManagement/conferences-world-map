<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Conferences 2026</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.css" rel="stylesheet" />
  <style>
    :root { --sidebar-w: 320px; --right-w: 380px; --font: "Century Gothic", CenturyGothic, AppleGothic, sans-serif; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: var(--font); }
    #map { position: absolute; top:0; bottom:0; left: var(--sidebar-w); right: var(--right-w); }
    #menu {
      position: absolute; top:0; left:0; bottom:0;
      width: var(--sidebar-w); overflow:auto; background:#fff;
      padding:16px 14px; border-right:1px solid #e6e6e6;
    }
    #cards-panel {
      position: absolute; top:0; right:0; bottom:0;
      width: var(--right-w); overflow:auto; background:#fafafa;
      border-left:1px solid #e6e6e6; padding:16px 14px;
    }
    .section-title { font-size:14px; font-weight:700; margin:12px 0 6px; }
    .checkbox-row { display:flex; align-items:center; gap:8px; font-size:14px; padding:4px 2px; border-radius:8px; }
    .checkbox-row:hover { background:#f7f7f7; }
    .dot { width:10px; height:10px; border-radius:50%; display:inline-block; border:1px solid rgba(0,0,0,.15); }

    .card-group { margin-bottom:16px; }
    .card-group-title { font-size:13px; font-weight:600; margin-bottom:6px; display:flex; align-items:center; gap:6px; }
    .card {
      background:white; border:1px solid #ddd; border-radius:10px;
      padding:10px 12px; margin-bottom:8px; box-shadow:0 1px 2px rgba(0,0,0,0.05);
      cursor:pointer; transition: background 0.2s, border-color 0.2s;
    }
    .card:hover { background:#f2f7ff; border-color:#aac8ff; }
    .card.selected { background:#e6f0ff; border-color:#4a90e2; box-shadow:0 0 0 2px rgba(74,144,226,0.4); }
    .card-title { font-size:14px; font-weight:600; }
    .card-sub { font-size:13px; color:#666; }
    .card-dates { font-size:12px; color:#444; margin-top:4px; }
    .card-link { display:inline-block; font-size:12px; margin-top:6px; text-decoration:underline; color:#1f6feb; }

    #view-toggle {
      display:flex; align-items:center; gap:8px; margin-bottom:10px; padding:8px 10px;
      background:#fff; border:1px solid #e6e6e6; border-radius:10px;
    }
    #view-toggle label { font-size:13px; display:flex; align-items:center; gap:6px; }
    #view-toggle input { accent-color:#4a90e2; }

    /* Buttons */
    .btn-row { display:flex; gap:8px; margin:10px 0 6px; }
    .btn {
      font-family: var(--font) !important;
      padding:10px 12px; font-size:14px; line-height:1;
      border-radius:6px; cursor:pointer; border:1px solid transparent;
      transition: background .15s ease, border-color .15s ease, color .15s ease;
    }
    #select-all-btn {
      background:#fff; border-color:#cfd9e3; color:#1f2d3d;
    }
    #select-all-btn:hover { background:#f5f8fb; border-color:#b9c8d8; }
    #clear-btn {
      color:#fff; background:#2B7DA6; border:1px solid #2B7DA6;
    }
    #clear-btn:hover { background:#1E88BD; border-color:#1E88BD; }

    .mapboxgl-popup, .mapboxgl-popup * { font-family: var(--font); }

    /* Brand header in the left sidebar */
    #brand {
      display:flex; flex-direction:column; align-items:center; gap:8px;
      padding:12px 8px 14px; border-bottom:1px solid #eee; margin-bottom:6px;
    }
    #brand .brand-logo { width:180px; height:80px; object-fit:contain; }
    /* Replaced bold title with a softer note */
    #brand .brand-note {
      font-size:14px; font-weight:400; color:#555; text-align:center;
    }

    /* -------- Mobile top bar + drawers -------- */
    #topbar {
      position: fixed; top: 0; left: 0; right: 0; height: 52px;
      display: none; align-items: center; justify-content: space-between;
      padding: 0 10px; background:#fff; border-bottom:1px solid #e6e6e6; z-index: 10;
      font-family: var(--font);
    }
    #topbar .tb-title { font-weight:700; letter-spacing:.2px; }
    #topbar .tb-btn {
      appearance: none; border:1px solid #d6d6d6; background:#fff; padding:6px 10px; border-radius:8px;
      font-size:14px; line-height:1; cursor:pointer; min-width:84px; text-align:center;
      transition: transform .05s ease;
    }
    #topbar .tb-btn:active { transform: translateY(1px); }

    /* Scrim behind drawers */
    #scrim { display:none; position: fixed; inset: 52px 0 0 0; background: rgba(0,0,0,.28); z-index: 10; }
    #scrim.show { display:block; }

    /* Mobile layout */
    @media (max-width: 900px) {
      #topbar { display:flex; padding-top: env(safe-area-inset-top); height: calc(52px + env(safe-area-inset-top)); }
      #map { top: calc(52px + env(safe-area-inset-top)); left: 0; right: 0; } /* map below the topbar */

      /* Turn side panels into drawers */
      #menu, #cards-panel {
        position: fixed; top: calc(52px + env(safe-area-inset-top)); bottom: 0;
        width: 88vw; max-width: 420px; background: #fff; z-index: 11;
        transition: transform .25s ease; box-shadow: 0 8px 24px rgba(0,0,0,.12);
      }
      #menu       { left: 0;  transform: translateX(-100%); }
      #menu.open  { transform: translateX(0); }
      #cards-panel       { right: 0; transform: translateX(100%); }
      #cards-panel.open  { transform: translateX(0); }

      /* Tighter paddings on small screens */
      #menu, #cards-panel { padding: 14px 12px; }
      .section-title { margin-top: 8px; }

      /* Larger tap targets */
      .checkbox-row { padding:6px 4px; }
      .card { padding:12px; }
      .btn { width:100%; }
      .btn-row { flex-direction:column; }
    }
  </style>
</head>
<body>

  <!-- Mobile top bar + scrim -->
  <div id="topbar">
    <button id="btn-filters" class="tb-btn" aria-controls="menu" aria-expanded="false">Filters</button>
    <div class="tb-title">Conferences Map</div>
    <button id="btn-cards" class="tb-btn" aria-controls="cards-panel" aria-expanded="false">Selected</button>
  </div>
  <div id="scrim" aria-hidden="true"></div>

  <div id="menu">
    <div id="brand">
      <img class="brand-logo" src="ABTSx4.png" alt="Logo">
      <div class="brand-note">Please select which specialty you would want to view below.</div>
    </div>

    <!-- Buttons above the list -->
    <div class="btn-row">
      <button id="select-all-btn" class="btn" type="button">Select All</button>
      <button id="clear-btn" class="btn" type="button">Clear All</button>
    </div>

    <div class="section-title">Subspecialties (A–Z)</div>
    <div id="filters"></div>
  </div>

  <div id="map"></div>

  <div id="cards-panel">
    <div class="section-title">Map view</div>
    <div id="view-toggle" role="group" aria-label="Map view">
      <label><input type="radio" name="mapview" value="2d" checked> 2D (streets)</label>
      <label><input type="radio" name="mapview" value="3d"> 3D globe</label>
    </div>

    <div class="section-title">Selected Conferences</div>
    <div id="cards"></div>
  </div>

  <script>
    // Token
    mapboxgl.accessToken = 'pk.eyJ1IjoibWFqYS1wYXZsaWNpYyIsImEiOiJjbWVpYnloeWowMG5xMmtzOGdnN2tjempnIn0.2LRD1_4AAyAVQWZ9kTZa2A';

    let activePopup = null;
    let activeCard = null;

    function closeActiveUI(){
      if (activePopup) { activePopup.remove(); activePopup = null; }
      if (activeCard)  { activeCard.classList.remove('selected'); activeCard = null; }
    }

    // Pardot link to special-case
    const PARDOT = 'https://go.pardot.com/l/1075812/2025-08-07/kcd92j';

    // City dictionary
    const cityCoords = {
      "San Francisco": [-122.4194, 37.7749],
      "Edinburgh": [-3.1883, 55.9533],
      "Dublin": [-6.2603, 53.3498],
      "Salt Lake City": [-111.8910, 40.7608],
      "San Diego": [-117.1611, 32.7157],
      "Hong Kong": [114.1694, 22.3193],
      "Stockholm": [18.0686, 59.3293],
      "Los Angeles": [-118.2437, 34.0522],
      "Copenhagen": [12.5683, 55.6761],
      "Lisabon": [-9.1393, 38.7223],
      "Lisbon": [-9.1393, 38.7223],
      "Miami": [-80.1918, 25.7617],
      "Phoenix": [-112.0740, 33.4484],
      "Orlando": [-81.3792, 28.5383],
      "Budapest": [19.0402, 47.4979],
      "London": [-0.1276, 51.5074],
      "Seville": [-5.9845, 37.3891],
      "Krakow": [19.9445, 50.0647],
      "San Antonio": [-98.4936, 29.4241],
      "New Orleans": [-90.0715, 29.9511],
      "Florence": [11.2558, 43.7696],
      "Denver": [-104.9903, 39.7392],
      "Prague": [14.4378, 50.0755],
      "Warsaw": [21.0122, 52.2297],
      "San Juan": [-66.1057, 18.4655],
      "São Paulo": [-46.6333, -23.5505],
      "Sao Paulo": [-46.6333, -23.5505],
      "Paris": [2.3522, 48.8566],
      "Munich": [11.5820, 48.1351],
      "Kuala Lumpur": [101.6869, 3.1390],
      "Washington, DC": [-77.0369, 38.9072],
      "Washington": [-77.0369, 38.9072],
      "Toronto": [-79.3832, 43.6532],
      "Berlin": [13.4050, 52.5200],
      "Istanbul, Turkey": [28.9784, 41.0082],
      "Istanbul": [28.9784, 41.0082],
      "Barcelona": [2.1734, 41.3851],
      "Charlotte": [-80.8431, 35.2271],
      "Chicago": [-87.6298, 41.8781],
      "Glasgow": [-4.2518, 55.8642],
      "Athens": [23.7275, 37.9838],
      "Philadelphia": [-75.1652, 39.9526],
      "Amsterdam": [4.9041, 52.3676],
      "Lugano": [8.9511, 46.0037],
      "Lille": [3.0573, 50.6292],
      "Geneva": [6.1432, 46.2044],
      "Queensland": [153.0251, -27.4698],
      "Marseilles": [5.3698, 43.2965],
      "Marseille": [5.3698, 43.2965],
      "Seoul": [126.978, 37.5665],
      "Hiroshima": [132.4553, 34.3853],
      "Vienna": [16.3738, 48.2082],
      "Thessaloniki": [22.9444, 40.6401],
      "Madrid": [-3.7038, 40.4168],
      "Las Vegas": [-115.1398, 36.1699],
      "Atlanta": [-84.388, 33.749],
      "Boston": [-71.0589, 42.3601],
      "San Diego County": [-117.1611, 32.7157]
    };

    const normalizeCity = (s) => {
      if (!s) return s;
      return s
        .replace(/\bChopenhagen\b/i, 'Copenhagen')
        .replace(/\bLisabon\b/i, 'Lisbon')
        .replace(/\bMarseilles\b/i, 'Marseille')
        .replace(/\bWashington\b(?!,\s*DC\b)/i, 'Washington, DC')
        .trim();
    };

    const palette = [
      "#e6194b","#3cb44b","#ffe119","#4363d8","#f58231","#911eb4","#46f0f0","#f032e6",
      "#bcf60c","#fabebe","#008080","#e6beff","#9a6324","#fffac8","#800000","#aaffc3",
      "#808000","#ffd8b1","#000075","#808080","#ffe4e1","#40e0d0","#6a3d9a","#b15928",
      "#2b908f","#ff7f0e","#1f77b4","#2ca02c","#d62728","#9467bd"
    ];

    // Map init (shifted east toward Europe + Asia)
    const map = new mapboxgl.Map({
      container:'map',
      style:'mapbox://styles/mapbox/streets-v12',
      center:[60, 34],   // ⬅️ moved east from [10,35] to reduce Africa in frame
      zoom:2.2,
      projection:'mercator'
    });

    let features = [];
    let distinctSubs = [];
    let subColor = {};
    const filtersRoot = document.getElementById('filters');
    const cardsRoot   = document.getElementById('cards');
    let initialized = false;

    // Load data from JSON (semester field is ignored)
    fetch('conferences_2026.updated.json')
      .then(r => r.json())
      .then(json => {
        features = jsonToFeatures(json);
        distinctSubs = [...new Set(features.map(f => f.properties.subcategory))].sort((a,b)=>a.localeCompare(b));
        subColor = {}; distinctSubs.forEach((s,i)=> subColor[s] = palette[i % palette.length]);

        if (map.loaded()) initLayersAndUI();
        else map.once('load', initLayersAndUI);
      })
      .catch(err => {
        console.error('Failed to load JSON', err);
        alert('Could not load conferences_2026.updated.json. Serve via http and check the path.');
      });

    // --- Helpers: dates ---
    function normalizeDate(s){
      if (!s) return null;
      const iso = /^\d{4}-\d{2}-\d{2}$/;
      const us  = /^\d{1,2}\/\d{1,2}\/\d{4}$/;
      try{
        if (iso.test(s)) return s;
        if (us.test(s)) {
          const [m,d,y] = s.split('/').map(Number);
          const mm = String(m).padStart(2,'0'), dd = String(d).padStart(2,'0');
          return `${y}-${mm}-${dd}`;
        }
      }catch(e){}
      return s;
    }

    // Convert JSON rows to GeoJSON features (no semester used anymore)
    function jsonToFeatures(rows){
      const feats = [];
      for (const r of rows){
        const sub  = r.subspecialty || r.sub || 'Other';
        const name = r.short_name || r.name || '(TBA)';
        const full = r.full_name || '';
        const cityRaw = normalizeCity(r.location_raw || r.city || '');
        const start = normalizeDate(r.start_date || r.start);
        const end   = normalizeDate(r.end_date   || r.end);
        const link  = r.link || '';

        let coords = null;
        if (Number.isFinite(r.lon) && Number.isFinite(r.lat)) {
          coords = [r.lon, r.lat];
        } else if (cityRaw && cityCoords[cityRaw]) {
          coords = cityCoords[cityRaw];
        }
        if (!coords) continue;

        const uid = [name, start || 'TBA', cityRaw || 'TBA', link || ''].join('|');

        feats.push({
          type:'Feature',
          properties:{
            subcategory: sub,
            name, full_name: full, location: cityRaw,
            start: start || 'TBA',
            end: end || 'TBA',
            link,
            uid
          },
          geometry:{ type:'Point', coordinates: coords }
        });
      }
      return feats;
    }

    function initLayersAndUI(){
      if (initialized) return;
      initialized = true;

      map.setPitch(0); map.setBearing(0);

      const data = { type:'FeatureCollection', features };
      map.addSource('conferences',{type:'geojson', data});

      const matchColor = ['match',['get','subcategory']];
      distinctSubs.forEach(s => { matchColor.push(s, subColor[s]); });
      matchColor.push('#ccc');

      map.addLayer({
        id:'conferences-layer', type:'circle', source:'conferences',
        paint:{ 'circle-radius':8, 'circle-color':matchColor, 'circle-stroke-width':1, 'circle-stroke-color':'#fff' }
      });

      buildSidebar();

      // ✅ Pre-select all subs on load
      document.querySelectorAll('#filters input[type=checkbox]').forEach(cb => cb.checked = true);
      applyFilters();

      // Optionally fit bounds to all points but bias view eastward
      try {
        const b = new mapboxgl.LngLatBounds();
        features.forEach(f => b.extend(f.geometry.coordinates));
        // Add padding and a slight eastward offset so Africa is less prominent
        map.fitBounds(b, { padding: {top: 40, bottom: 40, left: 80, right: 200}, maxZoom: 4 });
      } catch(e) { /* no-op if bounds fail */ }

      map.on('click','conferences-layer',(e)=>{
        const f = e.features[0], p = f.properties;
        openPopupAndSelectCard(f, p);
      });

      document.getElementById('view-toggle').addEventListener('change', (e) => {
        const input = e.target.closest('input'); if (!input) return;
        if (input.value === '2d') {
          map.setProjection('mercator');
          map.easeTo({ pitch: 0, bearing: 0, duration: 600 });
          map.setFog(null);
        } else if (input.value === '3d') {
          map.setProjection('globe');
          map.setFog({});
        }
      });

      // ---- Mobile drawers (filters & selected) with ✕ toggles ----
      const isMobile = () => window.matchMedia('(max-width: 900px)').matches;
      const topbarFiltersBtn = document.getElementById('btn-filters');
      const topbarCardsBtn   = document.getElementById('btn-cards');
      const scrim            = document.getElementById('scrim');
      const menuEl           = document.getElementById('menu');
      const cardsEl          = document.getElementById('cards-panel');

      let openDrawerName = null; // 'filters' | 'cards' | null

      function setTopbarUI(){
        topbarFiltersBtn.textContent = (openDrawerName === 'filters') ? '✕' : 'Filters';
        topbarCardsBtn.textContent   = (openDrawerName === 'cards')   ? '✕' : 'Selected';
        topbarFiltersBtn.setAttribute('aria-expanded', openDrawerName === 'filters');
        topbarCardsBtn.setAttribute('aria-expanded',   openDrawerName === 'cards');
      }

      function openDrawer(which){
        if (!isMobile()) return;
        if (openDrawerName === which) { closeDrawers(); return; }
        if (openDrawerName === 'filters') menuEl.classList.remove('open');
        if (openDrawerName === 'cards')   cardsEl.classList.remove('open');

        if (which === 'filters') menuEl.classList.add('open');
        if (which === 'cards')   cardsEl.classList.add('open');

        openDrawerName = which;
        scrim.classList.add('show');
        document.body.style.overflow='hidden';
        setTopbarUI();
      }

      function closeDrawers(){
        if (openDrawerName === 'filters') menuEl.classList.remove('open');
        if (openDrawerName === 'cards')   cardsEl.classList.remove('open');
        openDrawerName = null;
        scrim.classList.remove('show');
        document.body.style.overflow='';
        setTopbarUI();
      }

      topbarFiltersBtn.addEventListener('click', ()=> openDrawer('filters'));
      topbarCardsBtn.addEventListener('click',   ()=> openDrawer('cards'));
      scrim.addEventListener('click', closeDrawers);
      window.addEventListener('resize', ()=> { if (!isMobile()) closeDrawers(); });

      // expose to other functions (e.g., after selecting a card)
      window.__closeDrawersIfMobile = function(){
        if (isMobile() && openDrawerName) closeDrawers();
      };
      setTopbarUI();
    }

    function openPopupAndSelectCard(feature, props){
      if (activePopup) activePopup.remove();
      if (activeCard) activeCard.classList.remove('selected');

      const card = document.querySelector(`.card[data-uid="${CSS.escape(props.uid)}"]`);
      if (card) {
        card.classList.add('selected');
        activeCard = card;
        card.scrollIntoView({ behavior:'smooth', block:'center' });
      }

      const viewMode = document.querySelector('input[name="mapview"]:checked').value;
      if (viewMode === '3d') {
        map.easeTo({
          center: feature.geometry.coordinates,
          zoom: map.getZoom(),
          pitch: map.getPitch(),
          bearing: map.getBearing(),
          duration: 1500,
          essential: true
        });
      } else {
        map.easeTo({ center: feature.geometry.coordinates, duration: 800, pitch: 0, bearing: 0 });
      }

      // Swap Pardot link to email in popup
      let href = props.link || '';
      let label = 'Visit website';
      if (href && href.trim().toLowerCase() === PARDOT.toLowerCase()) {
        href = 'mailto:sgm@abts.com';
        label = 'send email';
      }
      const linkHTML = href ? `<div style="margin-top:6px"><a href="${href}" target="_blank" rel="noopener" style="color:#1f6feb;text-decoration:underline">${label}</a></div>` : '';

      const popup = new mapboxgl.Popup()
        .setLngLat(feature.geometry.coordinates)
        .setHTML(`
          <div style="font-weight:700">${props.name}</div>
          <div>${props.full_name || ''}</div>
          <div><b>${props.location || ''}</b></div>
          <div>${props.start} → ${props.end}</div>
          ${linkHTML}
        `)
        .addTo(map);

      activePopup = popup;
      popup.on('close', ()=>{
        if (activeCard) activeCard.classList.remove('selected');
        activeCard = null; activePopup = null;
      });

      if (window.__closeDrawersIfMobile) window.__closeDrawersIfMobile();
    }

    // Sidebar (A–Z subspecialties only)
    function colorDot(c){ return `<span class="dot" style="background:${c}"></span>`; }

    function buildSidebar(){
      const wrapper = document.createElement('div');
      distinctSubs.forEach(sub=>{
        const row=document.createElement('label');
        row.className='checkbox-row';
        row.innerHTML=`<input type="checkbox" data-sub="${sub}"> ${colorDot(subColor[sub])} ${sub}`;
        wrapper.appendChild(row);
      });

      const filtersRoot = document.getElementById('filters');
      filtersRoot.innerHTML=''; filtersRoot.appendChild(wrapper);

      // Buttons
      document.getElementById('select-all-btn').addEventListener('click', ()=>{
        document.querySelectorAll('#filters input[type=checkbox]').forEach(cb=> cb.checked = true);
        closeActiveUI();
        applyFilters();
      });

      document.getElementById('clear-btn').addEventListener('click', ()=>{
        document.querySelectorAll('#filters input[type=checkbox]').forEach(cb=> cb.checked = false);
        closeActiveUI();
        applyFilters();
      });

      filtersRoot.addEventListener('change', ()=>{
        closeActiveUI();
        applyFilters();
      });
    } // end buildSidebar

    // Apply filters using SUBSPECIALTY only
    function applyFilters(){
      const selectedSubs = [...document.querySelectorAll('#filters input[data-sub]:checked')]
        .map(i => i.dataset.sub);

      if (selectedSubs.length===0){
        if (map.getLayer('conferences-layer')){
          map.setFilter('conferences-layer',['==',['get','subcategory'],'__none__']);
        }
        closeActiveUI();
        cardsRoot.innerHTML='';
        return;
      }

      // Mapbox filter: OR of (subcategory == selected)
      const filter = ['any'];
      selectedSubs.forEach(sub => filter.push(['==', ['get','subcategory'], sub]));
      map.setFilter('conferences-layer', filter);

      // Build cards grouped by sub
      const bySub = {};
      features.forEach(f=>{
        const sub = f.properties.subcategory;
        if (selectedSubs.includes(sub)) {
          (bySub[sub] ||= []).push(f);
        }
      });

      const parse = (s)=> Date.parse(s) || Infinity;
      Object.values(bySub).forEach(arr => arr.sort((a,b)=> parse(a.properties.start)-parse(b.properties.start)));

      cardsRoot.innerHTML='';
      Object.keys(bySub).sort((a,b)=>a.localeCompare(b)).forEach(subLabel=>{
        const groupDiv=document.createElement('div'); groupDiv.className='card-group';
        groupDiv.innerHTML = `<div class="card-group-title">${colorDot(subColor[subLabel] || '#ccc')} ${subLabel}</div>`;

        bySub[subLabel].forEach(f=>{
          const p=f.properties;

          // Swap Pardot link to email in card list
          let href = p.link || '';
          let label = 'Visit website';
          if (href && href.trim().toLowerCase() === PARDOT.toLowerCase()) {
            href = 'mailto:sgm@abts.com';
            label = 'send email';
          }

          const card=document.createElement('div'); card.className='card';
          card.dataset.uid = p.uid;
          card.innerHTML=`
            <div class="card-title">${p.name}</div>
            <div class="card-sub">${p.location}</div>
            <div class="card-dates">${p.start} → ${p.end}</div>
            ${href ? `<a class="card-link" href="${href}" target="_blank" rel="noopener">${label}</a>` : ``}
          `;
          card.addEventListener('click', ()=> openPopupAndSelectCard(f, p));
          groupDiv.appendChild(card);
        });
        cardsRoot.appendChild(groupDiv);
      });
    }
  </script>
</body>
</html>
